# Как приручить сервисы-моки

## Предисловие
Эта статья продолжение первой части ["Интровертный" подход в тестировании API](https://habr.com).
Напомню, что в первой части мы говорили о: 
1. проблематика внешних зависимостей
2. базовые понятия о моках
3. виды моков, как и когда их лучше принять
4. Очень экспертно и профессионально решили, что в идеальном мире мы хотим использовать подход моков, как сервисов

Для лучшего понимания контекста и решаемой проблемы рекомендую ознакомиться с первой частью, хоть это и не обязательное условие.
Если все же вы не ознакамливались с первой частью, но уже сталкивались с внешними зависимостями 
или тестированием интеграций с внешними системами, имеете понимание о моках и о том, как они используются, то можете попытать счастье и сразу читать вторую часть.

В этой части мы: 
1. Очень кратко повторим, что такое сервисы-моки
2. Подумаем, как ~~меньше страдать~~ упростить себе жизни при написании сервисов-моков
3. Подробно и с примерами разберем лучшие практики при использовании подхода с сервисами-моками
4. ~~Выпьем пива за тех, кто решил этот подход использовать~~

# сервисы-моки, ХТО ВЫ (подумать над названием)?
кратко пояснить как используются мок сервисы, чтобы статью потенциально можно было бы прочитать в отрыве от первой части людьми, кто уже в теме.
привести примеры использований, можно схемку нарисовать, как они встраиваются

использовать мем, который скинул Леша про роутер mikrotik или как он там называется

Сервисы-моки - это инструмент, разворачиваемый отдельным деплоем во внутреннем контуре и эмулирующий поведение внешних зависимостей.
По сути реализует те же хендлеры или логику, что реализует внешний вендор, только находится в вашей власти.
Разрабатывается с учетом специфики и потребностей конкретного продукта/проекта.
Сложность реализуемых сценариев определяется только возможностями тех, кто этот инструмент разрабатывает.
Наиболее честный вариант с точки зрения встраивания в обычный бизнес процесс, максимально бесшовно может быть использован в боевых сервисах, в который они ходят.

По сути вы реализуете копию внешнего вендорского решения, но оптимизированную под ваши конкретные нужны и вашу конкретную специфику с возможностью любых модификаций и изменений.
Таким образом сервисы-моки -- наиболее продвинутый вариант с точки зрения качества продукта и решения проблемы с тестированием интеграции с внешними системами.

Но главный минус в том, что если хотите сделать что-то хорошо -- сделайте это сами.
Для этого я вас сегодня и собрал, мы попробуем справиться с этим небольшим, совсем крохотным нюансиком на пути к невероятным вершинам в мире тестирования и качества продукта!


# Бест практисы при написании сервисов-моков
Если вы знакомы с Моками и их реализациями, то часть пунктов будут для вас понятны, но для полноты картины о них стоит сказать:

## БАЗА
1. Для написания сервис-моков выбирайте язык программирования, на котором пишутся боевые сервисы, это позволит переиспользовать контракты, отдельные куски логики и инструменты.
Дополнительно: использование того-же языка, если он еще не является вашим основным — повысит экспертизу, что тоже является огромным плюсом, как минимум при реверс-инженеринге для написания моков
2. Релизный флоу, линтеры, форматтеры и прочие полезности так-же можно подрезать у разработки
3. Соответствуйте стандартам компании, поддерживайте обсервабилити/метрики/алерты/логи/версионнирование, мок не должен мыть месивом из костылей (мб поменять формулировку), это полноценный сервис
4. Никак не изменяйте и не дополняйте реальные контракты и хедеры, завязывайтесь на то, что уже есть в текущем флоу.

## Разгоняемся
5. Если есть тестовый стенд вендора не отрезайте возможность использовать его в тестах, реализуйте проксирование на уровне мока или реализуйте роутинг на уровне последнего сервиса в цепочке вызовов, которая идет в мок/к вендору.
Это позволит тестировать реальные контракты и повысит вероятность обнаружения других ошибок.
6. Обычно, по умолчанию лучше отдавать позитивные ответы, а для идентификации запросов на уровне мока, например, если требуется вернуть ошибку — используйте однозначные и неповторяющиеся ключи либо их комбинации, с которыми в мок приходят сами бизнес сервисы
7. Тесты интеграции с внешней системой должны иметь возможность влиять на ответы от мока, чтобы получить нужный им сценарий, при этом оставаться независимыми друг от друга, и при параллельном выполнении, и при последовательном (хочется другое слово подобрать, чтобы оно было из другой концепции, чем параллельное/последовательное исполнение) и вообще абсолютно всегда
8. При необходимости реализуйте на уровне мока дополнительные хендлеры для настройки ответов
9. Заготовленные ответы должны быть одноразовыми. 
Например: тест заказал определенный ответ/цепочку ответов по конкретному ключу -> в Ваш мок пришли с указанным ключом, отдали заказанный ответ -> созданный «заказ» должен быть удален (помечен, как удаленный)
10. Заказанный ответ долго не используется — то он должен считаться удаленным
Например: тест заказал нужный ему сценарий, но упал раньше, чем использовал его, при этом не почистил за собой. 
Заказанный сценарий остался лежать, как не использованный, соответственно может ошибочно использовать в другом месте, где он использовать не должен был.
В таком случае стоит игнорировать заказанные сценарии если за ними долго не приходят. Причем "Долго" лучше сделать  

## Замедляемся
11. QA, использующий мок должен минимально задумываться о том, как работает и как настраивается сам мок, в тестах это должно выглядеть максимально просто.  Обязательными параметрами при настройки мок-сервиса должны являться те, которые в Моке нельзя скалькулировать или оставить дефолтными значениями, остальные — опциональные 
12. Реализуйте только то, что требуется вашему бизнесу, не нужно поддерживать 100500 полей, которые умеет обрабатывать вендор, если сервис вашей компании использует только два из них
13. Старайтесь делать простую реализацию в лоб, если не требуется иного, не забываем, в чем именно задача мока
14. Большинство ваших мок-сервисов будут очень схожи по реализации, выносите повторы в пакеты
15. Явно отделяйте хендлеры, которые эмулируют бизнес-процессы и хендлеры, необходимые для настройки мока из тестов

